#  Copyright Perforator, Inc. and contributors. All rights reserved.
#
#  Use of this software is governed by the Business Source License
#  included in the LICENSE file.
#
#  As of the Change Date specified in that file, in accordance with
#  the Business Source License, use of this software will be governed
#  by the Apache License, Version 2.0.

---
suites:
  Suite One:
    steps:
      Open and run crawler:
        - sleep: 0.1s
        - crawler:
            url: https://verifications.perforator.io
            scriptTimeout: 30s
            pageLoadTimeout: 30s
            scroll: true
            scrollDelay: 2s-4s
            scrollScript: |
              const domains=arguments[0];
              window.scrollTo(0,document.documentElement.scrollHeight);
            click: true
            clickDelay: 2s-4s
            clickScript: |
              const domains=arguments[0];
              const linksToClick = [];
              const links = document.querySelectorAll("a[href]:not([href^='javascript']):not([href^='void']):not([href='#'])");
              const maxChecks = Math.min(links.length, 512);
              for(var i=0; i < maxChecks; i++){
                  if(links[i].checkVisibility({ opacityProperty: true, visibilityProperty: true, contentVisibilityAuto: true,})) {
                      try {
                          let url = new URL(links[i].href);
                          for(var j=0; j < domains.length; j++){
                              if(url.hostname === domains[j]) {
                                  linksToClick.push(links[i]);
                              }
                          }
                      } catch (error) {}
                  }
              }
              if(linksToClick.length > 0){
                  for(var i=0; i < 10; i++){
                      try {
                          let linkToClick = linksToClick[Math.floor(Math.random()*linksToClick.length)];
                          if("_blank" === linkToClick.getAttribute("target")) {
                              linkToClick.removeAttribute("target");
                          }
                          linkToClick.click();
                          return;
                      } catch (error) {}
                  }
              }
            linksExtractorScript: |
              const domains=arguments[0];
              const result = [];
              const links = document.querySelectorAll("a[href]:not([href^='javascript']):not([href^='void']):not([href='#'])");
              const maxChecks = Math.min(links.length, 512);
              for(var i=0; i < maxChecks; i++){
                  if(links[i].checkVisibility({ opacityProperty: true, visibilityProperty: true, contentVisibilityAuto: true,})) {
                      try {
                          let url = new URL(links[i].href);
                          for(var j=0; j < domains.length; j++){
                              if(url.hostname === domains[j]) {
                                  result.push(links[i].href);
                              }
                          }
                      } catch (error) {}
                  }
              }
              return result;