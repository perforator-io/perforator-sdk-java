variables:
  # load generator properties for tests
  LOADGENERATOR_APIBASEURL: $LOADGENERATOR_APIBASEURL
  LOADGENERATOR_APICLIENTID: $LOADGENERATOR_APICLIENTID
  LOADGENERATOR_APICLIENTSECRET: $LOADGENERATOR_APICLIENTSECRET
  LOADGENERATOR_PROJECTKEY: $LOADGENERATOR_PROJECTKEY
  # examples artifacts location
  EXAMPLES_ARTIFACTS: "./artifacts"
  EXAMPLES_PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/examples/${CI_COMMIT_TAG}"
  # API client
  EXAMPLES_API_CLIENT_SRC: "./examples/api-okhttp-gson"
  EXAMPLES_API_CLIENT_NAME: "examples-api-okhttp-gson-$CI_COMMIT_TAG"
  EXAMPLES_API_CLIENT_ZIP: "$EXAMPLES_API_CLIENT_NAME.zip"
  EXAMPLES_API_CLIENT_DST: "$EXAMPLES_ARTIFACTS/$EXAMPLES_API_CLIENT_ZIP"
  EXAMPLES_API_CLIENT_URL: "$EXAMPLES_PACKAGE_REGISTRY_URL/$EXAMPLES_API_CLIENT_ZIP"
  # TestNG
  EXAMPLES_TESTNG_SRC: "./examples/testng"
  EXAMPLES_TESTNG_NAME: "examples-testng-$CI_COMMIT_TAG"
  EXAMPLES_TESTNG_ZIP: "$EXAMPLES_TESTNG_NAME.zip"
  EXAMPLES_TESTNG_DST: "$EXAMPLES_ARTIFACTS/$EXAMPLES_TESTNG_ZIP"
  EXAMPLES_TESTNG_URL: "$EXAMPLES_PACKAGE_REGISTRY_URL/$EXAMPLES_TESTNG_ZIP"
  # Embedded
  EXAMPLES_EMBEDDED_SRC: "./examples/embedded"
  EXAMPLES_EMBEDDED_NAME: "examples-embedded-$CI_COMMIT_TAG"
  EXAMPLES_EMBEDDED_ZIP: "$EXAMPLES_EMBEDDED_NAME.zip"
  EXAMPLES_EMBEDDED_DST: "$EXAMPLES_ARTIFACTS/$EXAMPLES_EMBEDDED_ZIP"
  EXAMPLES_EMBEDDED_URL: "$EXAMPLES_PACKAGE_REGISTRY_URL/$EXAMPLES_EMBEDDED_ZIP"
  # Codeless
  EXAMPLES_CODELESS_SRC: "./examples/codeless"
  EXAMPLES_CODELESS_NAME: "examples-codeless-$CI_COMMIT_TAG"
  EXAMPLES_CODELESS_ZIP: "$EXAMPLES_CODELESS_NAME.zip"
  EXAMPLES_CODELESS_DST: "$EXAMPLES_ARTIFACTS/$EXAMPLES_CODELESS_ZIP"
  EXAMPLES_CODELESS_URL: "$EXAMPLES_PACKAGE_REGISTRY_URL/$EXAMPLES_CODELESS_ZIP"
 
  # General options for maven
  MAVEN_OPTS: >-
    -Dhttps.protocols=TLSv1.2
    -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository
    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN
    -Dorg.slf4j.simpleLogger.showDateTime=true
    -Djava.awt.headless=true
  # Execution specific maven options to be passed as command line arguments
  MAVEN_CLI_OPTS: >-
    --batch-mode
    --errors
    --show-version
    -DinstallAtEnd=true
    -DdeployAtEnd=true
    -Dsuite.chromeMode=headless

image: maven:3.9-amazoncorretto-11-debian

cache:
  paths:
    - .m2/repository

stages: 
  - build
  - test
  - deploy
  - release
  
build:
  stage: build
  script:
    - mvn clean package -s .gitlab-mvn-settings.xml -DskipTests $MAVEN_CLI_OPTS
    - echo "PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> build.env
  resource_group: one_at_time
  artifacts:
    reports:
      dotenv: build.env
  
test:
  stage: test
  before_script:
    - apt-get update && apt-get install -y chromium chromium-driver
  script:
    - mvn verify -s .gitlab-mvn-settings.xml -Dmaven.test.redirectTestOutputToFile=true $MAVEN_CLI_OPTS
  artifacts:
    when: always
    paths: 
      - ./**/target/surefire-reports/*
      - ./**/target/failsafe-reports/*
    reports:
      junit:
        - ./**/target/surefire-reports/TEST-*.xml
        - ./**/target/failsafe-reports/TEST-*.xml
  resource_group: one_at_time
  only:
    - main

deploy:
  stage: deploy
  script:
    - export BUILD_DIR=$(pwd)
    - apt-get update -qqy && apt-get install zip -qqy
    - mvn deploy -P-examples -s .gitlab-mvn-settings.xml -DskipTests $MAVEN_CLI_OPTS
    - mkdir $EXAMPLES_ARTIFACTS
    # API client
    - rm -rf $EXAMPLES_API_CLIENT_SRC/src/test
    - rm -rf $EXAMPLES_API_CLIENT_SRC/target
    - cp -R $EXAMPLES_API_CLIENT_SRC $EXAMPLES_ARTIFACTS/$EXAMPLES_API_CLIENT_NAME
    - cd $EXAMPLES_ARTIFACTS && zip -r -9 $EXAMPLES_API_CLIENT_ZIP $EXAMPLES_API_CLIENT_NAME && cd $BUILD_DIR
    - 'curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file $EXAMPLES_API_CLIENT_DST $EXAMPLES_API_CLIENT_URL'
    # TestNG
    - rm -rf $EXAMPLES_TESTNG_SRC/target
    - cp -R $EXAMPLES_TESTNG_SRC $EXAMPLES_ARTIFACTS/$EXAMPLES_TESTNG_NAME
    - cd $EXAMPLES_ARTIFACTS && zip -r -9 $EXAMPLES_TESTNG_ZIP $EXAMPLES_TESTNG_NAME && cd $BUILD_DIR
    - 'curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file $EXAMPLES_TESTNG_DST $EXAMPLES_TESTNG_URL'
    # Embedded
    - rm -rf $EXAMPLES_EMBEDDED_SRC/target
    - cp -R $EXAMPLES_EMBEDDED_SRC $EXAMPLES_ARTIFACTS/$EXAMPLES_EMBEDDED_NAME
    - cd $EXAMPLES_ARTIFACTS && zip -r -9 $EXAMPLES_EMBEDDED_ZIP $EXAMPLES_EMBEDDED_NAME && cd $BUILD_DIR
    - 'curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file $EXAMPLES_EMBEDDED_DST $EXAMPLES_EMBEDDED_URL'
    # Codeless
    - cp ./load-generator-codeless/target/perforator-sdk-load-generator-codeless-$PROJECT_VERSION-full.jar $EXAMPLES_CODELESS_SRC
    - sed -i "s/\${CODELESS_LOAD_GENERATOR_JAR}/perforator-sdk-load-generator-codeless-$PROJECT_VERSION-full.jar/g" $EXAMPLES_CODELESS_SRC/*.sh
    - sed -i "s/%CODELESS_LOAD_GENERATOR_JAR%/perforator-sdk-load-generator-codeless-$PROJECT_VERSION-full.jar/g" $EXAMPLES_CODELESS_SRC/*.cmd
    - cp -R $EXAMPLES_CODELESS_SRC $EXAMPLES_ARTIFACTS/$EXAMPLES_CODELESS_NAME
    - cd $EXAMPLES_ARTIFACTS && zip -r -9 $EXAMPLES_CODELESS_ZIP $EXAMPLES_CODELESS_NAME && cd $BUILD_DIR
    - 'curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file $EXAMPLES_CODELESS_DST $EXAMPLES_CODELESS_URL'
  resource_group: one_at_time
  rules:
    - if: '$CI_COMMIT_TAG =~ /^release-*/'

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo 'Releasing $CI_COMMIT_TAG'
  release:
    name: $CI_COMMIT_TAG
    tag_name: $CI_COMMIT_TAG
    description: $CI_COMMIT_TAG
    assets:
      links:
        - name: $EXAMPLES_API_CLIENT_ZIP
          url: $EXAMPLES_API_CLIENT_URL
          filepath: /examples/$EXAMPLES_API_CLIENT_ZIP
          link_type: package
        - name: $EXAMPLES_TESTNG_ZIP
          url: $EXAMPLES_TESTNG_URL
          filepath: /examples/$EXAMPLES_TESTNG_ZIP
          link_type: package
        - name: $EXAMPLES_EMBEDDED_ZIP
          url: $EXAMPLES_EMBEDDED_URL
          filepath: /examples/$EXAMPLES_EMBEDDED_ZIP
          link_type: package
        - name: $EXAMPLES_CODELESS_ZIP
          url: $EXAMPLES_CODELESS_URL
          filepath: /examples/$EXAMPLES_CODELESS_ZIP
          link_type: package
  resource_group: one_at_time
  rules:
    - if: '$CI_COMMIT_TAG =~ /^release-*/'
